#!/usr/bin/env bash

# -----------------------------------------------------------------------------
#                               INITIAL TEST
# -----------------------------------------------------------------------------

if [[ $(cat /proc/$$/comm) != "bash" ]]; then
    echo "This is not a bash shell; this script runs exclusively in bash"
    return;
fi

# get distribution name; TODO: if needed, this can be automated by reading
# /etc/os-release
DISTRO=$1; ___() {
    if [ -z $DISTRO ]; then
        echo -e "---Choose your distribution---"
        DISTRIBUTIONS=("arch" "ubuntu" "alpine")

        select DISTRO in "${DISTRIBUTIONS[@]}"; do
          break;
        done
    fi
};___;

# # -----------------------------------------------------------------------------
# #                                  SETUP
# # -----------------------------------------------------------------------------

# installing basic necessities
function preinstal() {
    case $1 in
        "arch")
            pacman -Syyu --noconfirm;
            pacman -S git fontconfig --noconfirm;
            ;;
        "ubuntu")
            apt update -y;
            apt upgrade -y;
            apt install git fontconfig -y;
            ;;
        "alpine")
            apk update;
            apk upgrade;
            apk add git fontconfig;
            ;;
        *)
            echo -e "Unknown distribution"
            ;;
    esac
}

# create the directory structure
function mkuserdirs() {
    mkdir -p $HOME/.local/{bin,cache,data,src,logs}

    ln -sf $HOME/.local/data $HOME/.local/share
    ln -sf $HOME/.local/logs $HOME/.local/state

    mkdir -p $HOME/{downloads,documents}
}

# clone the configurations
function cloneconfigs() {
    read -p "Ensure that the GitHub repository for RMOS is public. [ENTER]" 
    
    # cloning from HTTPS since SSH has not yet been configured
    git clone https://github.com/ramyamounir/rmos.git $HOME/temp
    mv $HOME/temp/* $HOME
    mv $HOME/temp/.* $HOME
    mv $HOME/.git $HOME/.rmos
    rm -rf $HOME/temp

    # modify HTTPS origin to SSH
    git --git-dir $HOME/.rmos remote set-url origin git@github.com:ramyamounir/rmos.git

    # set some basic configs
    git --git-dir $HOME/.rmos config --local status.showuntrackedfiles no
    git --git-dir $HOME/.rmos config --local pull.rebase off
    git --git-dir $HOME/.rmos config --local pull.default current
    git --git-dir $HOME/.rmos config --local push.default current    
}

function setupshell() {
    source $HOME/.config/shell/variables.sh;

    # shell configuration links
    ln -sf $XDG_CONFIG_HOME/bash/.bashrc $HOME/
    ln -sf $XDG_CONFIG_HOME/bash/.bash_profile $HOME/
    ln -sf $XDG_CONFIG_HOME/zsh/.zprofile $HOME/
    ln -sf $XDG_CONFIG_HOME/ssh $HOME/.ssh

    $XDG_CONFIG_HOME/scripts/setpermissions
}

# a function that installs apps depending on the OS distribution
function instalappswithpm() {
    function instal_commence() {
        echo "Installing $1 packages..."
        echo -e "This may take several tens of minutes; please be patient..."
    }

    function instal_arch() {
        read -p "GUI support needed (instals DWM) [y/n]? " GUI_SUPPORT

        function cli() {
            $XDG_CONFIG_HOME/scripts/instalfromcsv $XDG_CONFIG_HOME/packages/minimal/arch.csv
        }

        function gui() {
            $XDG_CONFIG_HOME/scripts/instalfromcsv $XDG_CONFIG_HOME/packages/arch/user.csv -s;

            # link files and directories
            $XDG_CONFIG_HOME/scripts/applysettings alllinks;
        }
        
        if [[ "$GUI_SUPPORT" == "y" ]]; then
            gui
        else
            cli
        fi
    }

    function instal_alpine() {
        $XDG_CONFIG_HOME/scripts/instalfromcsv $XDG_CONFIG_HOME/packages/minimal/alpine.csv
    }

    function instal_ubuntu() {
        $XDG_CONFIG_HOME/scripts/instalfromcsv $XDG_CONFIG_HOME/packages/minimal/ubuntu.csv
    }

    case $1 in
        "arch")
            instal_commence $DISTRO;
            instal_arch;;
        "ubuntu")
            instal_commence $DISTRO;
            instal_ubuntu > /dev/null 2>&1;;
        "alpine")
            instal_commence $DISTRO;
            instal_alpine > /dev/null 2>&1;;
        *)
            echo "Unknown distribution";;
    esac

    # instal fonts
    [ command -v fc-cache &> /dev/null ] && fc-cache -fr > /dev/null;
}

function instalwithconda() {
    read -p "Enter the latest conda download script URL: " CONDASCRIPTURL
    read -p "Make sure that the installation path is: $HOME/.local/src/anaconda3 [ENTER] "

    curl $CONDASCRIPTURL > temp.sh
    sh temp.sh
    rm temp.sh

    $XDG_CONFIG_HOME/scripts/instalfromcsv $XDG_CONFIG_HOME/packages/arch/conda.csv
    $XDG_CONFIG_HOME/scripts/linkbinsfromconda
}

function instalapps() {
    read -p "Install with the system's package manager (p) or conda (c)? " PM

    case $PM in
        "p")
            instalappswithpm $1;;
        "c")
            instalwithconda;;
    esac
}

function getwallpapers() {
    git clone https://github.com/ramyamounir/wallpapers.git $HOME/.local/wallpapers
}

echo -e "[1 of 5]: Pre-requisites: installing basic packages..."
echo -e "This may take several minutes; please be patient..."
preinstal $DISTRO > /dev/null 2>&1;

echo -e "[1 of 5]: Creating directories..."
mkuserdirs > /dev/null 2>&1;

read -p "[2 of 5]: Clone configs [y/n]? " CLONE_CONFIGS
[[ "$CLONE_CONFIGS" == "y" ]] && cloneconfigs;

echo -e "[3 of 5]: Applying user configurations..."
setupshell > /dev/null 2>&1;

echo -e "[4 of 5]: Installing user apps and fonts..."
instalapps $DISTRO;

echo -e "[5 of 5]: Getting wallpapers..."
getwallpapers;

echo "User setup finished."

[ command -v chsh &> /dev/null ] && chsh -s $(which zsh) $USER
exec $(which zsh)


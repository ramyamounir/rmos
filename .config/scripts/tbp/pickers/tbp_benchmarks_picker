#!/usr/bin/env bash
set -euo pipefail

# pick_side_value_simple.sh
# Prints exactly one thing to stdout:
#   - repo: the FULL PATH to the selected repo folder under ~/tbp/<key>
#   - wandb: the FULL PATH to the selected CSV under ~/tbp/tbp.benchmarks/wandb_files/<file>.csv

command -v jq  >/dev/null 2>&1 || { echo "jq is required" >&2; exit 2; }
command -v fzf >/dev/null 2>&1 || { echo "fzf is required" >&2; exit 2; }

RUNMAP_JSON="${HOME}/.config/tbp/mappers/runmap.json"
WANDB_DIR="${HOME}/tbp/tbp.benchmarks/wandb_files"

# Step 1: select type
type_choice="$(printf '%s\n' repo wandb | fzf --prompt='Type (repo|wandb): ' --no-multi)"
[ -n "$type_choice" ] || exit 1

if [ "$type_choice" = "repo" ]; then
  [ -f "$RUNMAP_JSON" ] || { echo "Missing: $RUNMAP_JSON" >&2; exit 2; }

  # options = top-level keys
  mapfile -t options < <(jq -r 'keys[]' "$RUNMAP_JSON")
  [ ${#options[@]} -gt 0 ] || { echo "No keys in $RUNMAP_JSON" >&2; exit 2; }

  # Preview: show folder contents at $HOME/tbp/<key>
  preview_repo='
key={}
dir="$HOME/tbp/$key"
printf "Will return: %s\n\n" "$dir"
if [ -d "$dir" ]; then
  printf "Path: %s\n\n" "$dir"
  ls -lA -- "$dir" 2>/dev/null | head -n 60
else
  printf "Directory not found:\n  %s\n" "$dir"
fi
'

  choice="$(
    printf '%s\n' "${options[@]}" | fzf \
      --prompt='Repo key: ' \
      --no-multi \
      --preview "$preview_repo" \
      --preview-window='down:18'
  )"
  [ -n "$choice" ] || exit 1

  # Return FULL PATH, not the key.
  printf '%s\n' "$HOME/tbp/$choice"
  exit 0
fi

if [ "$type_choice" = "wandb" ]; then
  [ -d "$WANDB_DIR" ] || { echo "Missing dir: $WANDB_DIR" >&2; exit 2; }

  shopt -s nullglob
  files=( "$WANDB_DIR"/*.csv )
  shopt -u nullglob
  [ ${#files[@]} -gt 0 ] || { echo "No CSVs in $WANDB_DIR" >&2; exit 2; }

  mapfile -t basenames < <(for f in "${files[@]}"; do basename -- "$f"; done | sort)

  # Preview: pretty-print CSV if possible
  preview_wandb='
bn={}
dir="${PREVIEW_WANDB_DIR}"
full="${dir}/${bn}"
printf "Will return: %s\n\n" "$full"
if [ -f "$full" ]; then
  rows="$(wc -l < "$full" 2>/dev/null || echo "?")"
  if stat --version >/dev/null 2>&1; then size="$(stat -c%s "$full")"; else size="$(stat -f%z "$full")"; fi
  printf "File: %s\nRows: %s  Size: %s bytes\n\n" "$full" "$rows" "$size"
  if command -v csvlook >/dev/null 2>&1; then
    head -n 40 -- "$full" | csvlook -I
  elif command -v mlr >/dev/null 2>&1; then
    head -n 40 -- "$full" | mlr --icsv --opprint cat
  else
    head -n 40 -- "$full" | sed "s/\r$//" | column -s, -t
  fi
else
  printf "Not found: %s\n" "$full"
fi
'

  choice="$(
    printf '%s\n' "${basenames[@]}" | \
    PREVIEW_WANDB_DIR="$WANDB_DIR" \
    fzf \
      --prompt='WANDB csv: ' \
      --no-multi \
      --preview "$preview_wandb" \
      --preview-window='down:20'
  )"
  [ -n "$choice" ] || exit 1

  # Return FULL PATH, not just the basename.
  printf '%s\n' "$WANDB_DIR/$choice"
  exit 0
fi

echo "Unknown type: $type_choice" >&2
exit 2

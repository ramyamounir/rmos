#!/usr/bin/env zsh
set -euo pipefail

source "$HOME/.config/scripts/tbp/tbp_common.zsh"

repo="$(tbp_repo_key)"
vars_json="$(json_get_repo "$repo" || true)"

if [[ -z "$vars_json" ]]; then
  print -u2 -- "No config for '$repo' in $TBP_ENVMAP. Nothing to unset."
else
  var_names=("${(@f)$(python - <<'PY' "$vars_json"
import json, sys
obj = json.loads(sys.argv[1])
for k in obj.keys():
    print(k)
PY
)}")
  for v in "${var_names[@]}"; do
    envrc_unset "$v"
  done
fi

envrc_unset "CTX_ACTIVE"

direnv_apply

